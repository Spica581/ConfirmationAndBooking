@page
@model ForewayApp.Pages.FlightsModel
@{
    ViewData["Title"] = "Search Flights";
}

<div class="page-card">

    <!-- Title Bar -->
    <div class="page-title-bar">
        <h1>âœˆ Search Flights</h1>
        <div class="flex gap-2">
            <a href="/FlightDetails" class="btn btn-outline btn-sm" aria-label="View flight details">ðŸ“‹ View Details</a>
            <a href="/Book/Step1"    class="btn btn-success btn-sm"  aria-label="Book a flight">ðŸŽ« Book Now</a>
        </div>
    </div>

    <!-- Search Card (never scrolls) -->
    <div style="padding:0.75rem 1.5rem; flex-shrink:0; border-bottom:1px solid #f0ebff;">
        <div class="search-card">
            <form method="get" class="form-grid-5">
                <div>
                    <label class="label">From</label>
                    <input type="text" name="From" value="@Model.Search.From" class="input" aria-label="Departure airport" />
                </div>
                <div>
                    <label class="label">To</label>
                    <input type="text" name="To" value="@Model.Search.To" class="input" aria-label="Destination airport" />
                </div>
                <div>
                    <label class="label">Depart</label>
                    <input type="date" name="Depart" value="@Model.Search.Depart.ToString("yyyy-MM-dd")" class="input" />
                </div>
                <div>
                    <label class="label">Return</label>
                    <input type="date" name="Return" value="@Model.Search.Return.ToString("yyyy-MM-dd")" class="input" />
                </div>
                <div>
                    <label class="label">Passengers</label>
                    <div class="flex gap-2">
                        <select name="Adults" class="input" style="width:50%;" aria-label="Number of adults">
                            @for(int i=1;i<=9;i++){<option value="@i" selected="@(Model.Search.Adults==i?"selected":null)">@i Adult@(i>1?"s":"")</option>}
                        </select>
                        <select name="Children" class="input" style="width:50%;" aria-label="Number of children">
                            @for(int i=0;i<=9;i++){<option value="@i" selected="@(Model.Search.Children==i?"selected":null)">@i Child@(i!=1?"ren":"")</option>}
                        </select>
                    </div>
                </div>
                <div><button type="submit" class="btn btn-primary btn-full">Search</button></div>
            </form>
        </div>
    </div>

    <!-- Filters strip -->
    <div class="action-bar">
        <span class="text-xs text-gray" style="margin-right:.25rem;">Filter:</span>
        <select class="input" style="width:auto;padding:.3rem .6rem;font-size:.75rem;" aria-label="Filter by max price"><option>Max Price</option><option>Under $700</option><option>Under $1000</option></select>
        <select class="input" style="width:auto;padding:.3rem .6rem;font-size:.75rem;" aria-label="Filter by stops"><option>Stops</option><option>Non-stop</option><option>1 stop</option></select>
        <select class="input" style="width:auto;padding:.3rem .6rem;font-size:.75rem;" aria-label="Filter by airline"><option>Airline</option><option>Hawaiian</option><option>JAL</option></select>
        <select class="input" style="width:auto;padding:.3rem .6rem;font-size:.75rem;" aria-label="Filter by seat class"><option>Class</option><option>Economy</option><option>Business</option></select>
    </div>

    <!-- Main two-column area (scrollable) -->
    <div style="flex:1;display:grid;grid-template-columns:1fr 220px;gap:0;min-height:0;overflow:hidden;">

        <!-- Flight list column -->
        <div style="display:flex;flex-direction:column;min-height:0;border-right:1px solid #f0ebff;">
            <div class="scroll-zone" style="padding-bottom:.5rem;">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-semibold text-dark">@Model.Flights.Count results</span>
                    <span class="text-xs text-gray">SFO â†’ NRT Â· Round trip</span>
                </div>
                <div style="display:flex;flex-direction:column;gap:.5rem;">
                    @foreach (var f in Model.PagedFlights)
                    {
                        <div class="flight-card-result" role="article" aria-label="@f.Airline flight option">
                            <div class="airline-badge" aria-hidden="true">@f.AirlineCode</div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="route-time">@f.DepartTime</span>
                                    <span class="route-arrow">â†’</span>
                                    <span class="route-time">@f.ArriveTime</span>
                                    <span class="text-xs text-gray" style="margin-left:.25rem;">@f.Duration</span>
                                </div>
                                <div class="route-meta">@f.Airline Â· @f.Stops stop@(f.Stops!=1?"s":"") (@f.StopDetail)</div>
                            </div>
                            <div class="flight-action">
                                <div class="flight-price">$@f.Price.ToString("N0")</div>
                                <a href="/FlightDetails?airline=@Uri.EscapeDataString(f.Airline)&price=@f.Price"
                                   class="btn btn-outline btn-sm" aria-label="View details for @f.Airline">Details</a>
                                <a href="/Book/Step1"
                                   class="btn btn-primary btn-sm" aria-label="Select @f.Airline flight">Select</a>
                            </div>
                        </div>
                    }
                </div>

                <!-- Pagination -->
                <div class="pagination" aria-label="Flight results pagination">
                    <a href="?page=@(Model.CurrentPage-1)" class="page-btn @(Model.CurrentPage<=1?"disabled":"")" aria-label="Previous page">â€¹</a>
                    @for(int p=1;p<=Model.TotalPages;p++){
                        <a href="?page=@p" class="page-btn @(p==Model.CurrentPage?"active":"")" aria-label="Page @p">@p</a>
                    }
                    <a href="?page=@(Model.CurrentPage+1)" class="page-btn @(Model.CurrentPage>=Model.TotalPages?"disabled":"")" aria-label="Next page">â€º</a>
                </div>
            </div>
        </div>

        <!-- Right panel -->
        <div style="display:flex;flex-direction:column;gap:.75rem;padding:.875rem;overflow-y:auto;min-height:0;scrollbar-width:thin;scrollbar-color:#a78bfa #f1f5f9;">

            <!-- Buy soon -->
            <div class="buy-soon" role="complementary" aria-label="Pricing alert">
                <h3>âš¡ Buy Soon</h3>
                <p class="text-xs text-gray mb-2">Prices may rise <strong>18%</strong> in the next 2 weeks.</p>
                <a href="/Book/Step1" class="btn btn-success btn-full btn-sm">Book Now</a>
            </div>

            <!-- Price heatmap -->
            <div style="background:#fff;border:1px solid #e8e0fa;border-radius:.75rem;padding:.75rem;">
                <div class="font-semibold text-xs text-purple mb-2" style="text-transform:uppercase;letter-spacing:.05em;">Flexible Dates</div>
                <table class="heatmap-table" aria-label="Price grid for flexible dates">
                    <thead>
                        <tr><th></th>
                            @foreach(var d in Model.HeatmapDepartures){<th>@d</th>}
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var row in Model.HeatmapRows){
                            <tr><td><strong>@row.ReturnDate</strong></td>
                                @foreach(var c in row.Cells){<td class="@c.CssClass">$@c.Price.ToString("N0")</td>}
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Price chart (compact) -->
            <div style="background:#fff;border:1px solid #e8e0fa;border-radius:.75rem;padding:.75rem;">
                <div class="font-semibold text-xs text-purple mb-2" style="text-transform:uppercase;letter-spacing:.05em;">Price History</div>
                <canvas id="priceChart" aria-label="Price history chart" role="img"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    new Chart(document.getElementById('priceChart'), {
        type:'line',
        data:{
            labels:['Jan','Feb','Mar','Apr','May','Jun'],
            datasets:[{label:'Avg Price',data:[1000,920,850,760,710,680],
                borderColor:'#7c3aed',backgroundColor:'rgba(124,58,237,.08)',
                tension:.4,fill:true,pointBackgroundColor:'#7c3aed',pointRadius:3}]
        },
        options:{responsive:true,plugins:{legend:{display:false}},
                 scales:{y:{ticks:{callback:v=>'$'+v,font:{size:9}},grid:{color:'#f0ebff'}},
                         x:{ticks:{font:{size:9}},grid:{display:false}}}}
    });
</script>
}
