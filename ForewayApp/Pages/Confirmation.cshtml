@page
@model ForewayApp.Pages.ConfirmationModel
@{
    ViewData["Title"] = "Booking Confirmation";
    var b = Model.Booking;
}

<div class="page-card">

    <div class="page-title-bar">
        <div class="flex items-center gap-3">
            <h1>üéâ Booking Confirmation</h1>
            <span class="badge badge-pending">@b.Status</span>
        </div>
        <div class="flex gap-2">
            <a href="/Manage"  class="btn btn-ghost btn-sm"  aria-label="View all bookings">üìÇ All Bookings</a>
            <a href="/Flights" class="btn btn-outline btn-sm" aria-label="Search more flights">üîç New Search</a>
        </div>
    </div>

    <!-- Content area -->
    <div style="flex:1;display:grid;grid-template-columns:1fr 320px;gap:0;overflow:hidden;min-height:0;" class="confirm-layout">

        <!-- LEFT: main confirmation content -->
        <div class="confirm-left" style="padding:.875rem 1.25rem;border-right:1px solid #f0ebff;">

            <!-- Pending notice -->
            <div class="notice notice-warn" role="alert">
                <span class="notice-icon">‚ö†Ô∏è</span>
                <div>
                    <h4 class="text-orange">Your flight is pending</h4>
                    <span>If we can't confirm within 72 hours, we'll email you at <strong>@b.ConfirmationEmail</strong> and issue a full refund.</span>
                </div>
            </div>

            <!-- Thank you + ticket ID -->
            <div>
                <div class="font-bold text-dark" style="font-size:1.05rem;margin-bottom:.3rem;">
                    Thanks <strong>@b.Traveler1.FullName</strong> for choosing Foreway!
                </div>
                <span class="badge badge-ticket" style="font-size:.75rem;padding:.3rem .85rem;">üÖ± Ticket ID: @b.TicketId</span>
            </div>

            <!-- Free cancellation -->
            <div class="notice notice-info">
                <span class="notice-icon">üåü</span>
                <div>
                    <h4 class="text-purple">Free 24-Hour Cancellation</h4>
                    <span>Contact support within 24 hours of booking for a full refund.</span>
                </div>
            </div>

            <!-- Flight legs -->
            @if (b.OutboundLeg != null)
            {
                <div class="leg-card">
                    <h4>üõ´ @b.OutboundLeg.Title ‚Äî @(b.OutboundLeg.Segments.Count - 1 == 0 ? "Non-Stop" : $"{b.OutboundLeg.Segments.Count-1}-Stop") ¬∑ @b.OutboundLeg.Duration</h4>
                    @foreach(var seg in b.OutboundLeg.Segments)
                    {
                        <div class="leg-row mb-1">
                            <div>
                                <div class="leg-time">@seg.DepartTime</div>
                                <div class="leg-apt">@seg.DepartAirport</div>
                            </div>
                            <div class="leg-arrow">‚Äî‚Äî‚Üí</div>
                            <div class="leg-dur">@seg.FlightDuration<br/><span class="text-xs text-gray">@seg.FlightNumber</span></div>
                            <div>
                                <div class="leg-time">@seg.ArriveTime</div>
                                <div class="leg-apt">@seg.ArriveAirport</div>
                            </div>
                        </div>
                        <div class="leg-meta">@seg.Class ¬∑ RECORD: PENDING</div>
                    }
                    @if (!string.IsNullOrEmpty(b.OutboundLeg.LayoverNote))
                    {
                        <div style="background:rgba(109,40,217,.07);border-left:3px solid #7c3aed;padding:.25rem .6rem;border-radius:0 .3rem .3rem 0;font-size:.7rem;color:#4c1d95;font-weight:600;margin-top:.3rem;">@b.OutboundLeg.LayoverNote</div>
                    }
                </div>
            }

            @if (b.ReturnLeg != null)
            {
                <div class="leg-card">
                    <h4>üõ¨ @b.ReturnLeg.Title ‚Äî @(b.ReturnLeg.Segments.Count - 1 == 0 ? "Non-Stop" : $"{b.ReturnLeg.Segments.Count-1}-Stop") ¬∑ @b.ReturnLeg.Duration</h4>
                    @foreach(var seg in b.ReturnLeg.Segments)
                    {
                        <div class="leg-row mb-1">
                            <div><div class="leg-time">@seg.DepartTime</div><div class="leg-apt">@seg.DepartAirport</div></div>
                            <div class="leg-arrow">‚Äî‚Äî‚Üí</div>
                            <div class="leg-dur">@seg.FlightDuration</div>
                            <div><div class="leg-time">@seg.ArriveTime</div><div class="leg-apt">@seg.ArriveAirport</div></div>
                        </div>
                        <div class="leg-meta">@seg.Class ¬∑ RECORD: PENDING</div>
                    }
                </div>
            }

            <!-- Passenger Flight Status Pie Chart -->
            <div class="chart-panel">
                <h3>üìä Passenger Flight Status Overview</h3>
                <div class="flex items-center gap-4" style="min-height:160px;">
                    <div style="width:160px;height:160px;flex-shrink:0;">
                        <canvas id="passengerChart"
                                aria-label="Pie chart showing pending vs completed flights"
                                role="img"></canvas>
                    </div>
                    <div style="flex:1;">
                        <div class="font-semibold text-xs text-purple mb-2" style="text-transform:uppercase;letter-spacing:.05em;">Legend</div>
                        <div class="flex items-center gap-2 mb-1 text-sm">
                            <span style="width:12px;height:12px;background:#f59e0b;border-radius:50%;display:inline-block;flex-shrink:0;"></span>
                            Pending Flights ‚Äî @Model.Booking.PendingCount (@Model.Booking.PendingPct%)</div>
                        <div class="flex items-center gap-2 mb-1 text-sm">
                            <span style="width:12px;height:12px;background:#10b981;border-radius:50%;display:inline-block;flex-shrink:0;"></span>
                            Completed Flights ‚Äî @Model.Booking.CompletedCount (@Model.Booking.CompletedPct%)</div>
                        <div class="flex items-center gap-2 text-sm">
                            <span style="width:12px;height:12px;background:#6d28d9;border-radius:50%;display:inline-block;flex-shrink:0;"></span>
                            Cancelled ‚Äî @Model.Booking.CancelledCount (@Model.Booking.CancelledPct%)</div>
                        <div class="text-xs text-gray mt-2">Based on @Model.Booking.TotalFlights total bookings across all passengers.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: sidebar -->
        <div class="confirm-right" style="padding:.875rem;">

            <!-- Traveler cards -->
            <div class="sidebar-card">
                <h3>Traveler #1</h3>
                <div class="cost-row"><span class="text-xs text-purple font-semibold">Name</span><span class="text-xs">@b.Traveler1.FullName</span></div>
                <div class="cost-row"><span class="text-xs text-purple font-semibold">DOB</span><span class="text-xs">@b.Traveler1.DateOfBirth</span></div>
                <div class="cost-row"><span class="text-xs text-purple font-semibold">Gender</span><span class="text-xs">@b.Traveler1.Gender</span></div>
                <div class="cost-row"><span class="text-xs text-purple font-semibold">Email</span><span class="text-xs">@b.Traveler1.Email</span></div>
                <div class="cost-row"><span class="text-xs text-purple font-semibold">Phone</span><span class="text-xs">@b.Traveler1.Phone</span></div>
            </div>

            @if(b.Traveler2 != null){
                <div class="sidebar-card">
                    <h3>Traveler #2</h3>
                    <div class="cost-row"><span class="text-xs text-purple font-semibold">Name</span><span class="text-xs">@b.Traveler2.FullName</span></div>
                    <div class="cost-row"><span class="text-xs text-purple font-semibold">DOB</span><span class="text-xs">@b.Traveler2.DateOfBirth</span></div>
                    <div class="cost-row"><span class="text-xs text-purple font-semibold">Email</span><span class="text-xs">@b.Traveler2.Email</span></div>
                </div>
            }

            <!-- Cost -->
            <div class="sidebar-card">
                <h3>Cost &amp; Billing</h3>
                <div class="cost-row"><span class="cost-indent">Fare √ó@b.AdultCount</span><span>$@b.FarePerAdult.ToString("N2")</span></div>
                <div class="cost-row"><span class="cost-indent">Taxes √ó@b.AdultCount</span><span>$@b.TaxesPerAdult.ToString("N2")</span></div>
                <div class="cost-row"><span>Total</span><span>$@b.Total.ToString("N2")</span></div>
            </div>

            <!-- Policies (compact) -->
            <div class="sidebar-card">
                <h3>Policies</h3>
                <p class="text-xs text-gray" style="line-height:1.55;">Valid photo ID required at check-in. Visa and health documentation are the passenger's responsibility. Information here is provided as a courtesy ‚Äî verify requirements with the destination country's consul.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // ----------------------------------------------------------------
    // Passenger Flight Status Pie Chart (Chart.js)
    // Data is pulled from the Razor model (ConfirmationModel).
    // In production, wire Model.PendingCount / CompletedCount / CancelledCount
    // to a real database via Entity Framework (e.g., DbContext.Bookings.Count()).
    // ----------------------------------------------------------------
    (function() {
        var ctx = document.getElementById('passengerChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Pending Flights', 'Completed Flights', 'Cancelled'],
                datasets: [{
                    data: [@Model.Booking.PendingCount, @Model.Booking.CompletedCount, @Model.Booking.CancelledCount],
                    backgroundColor: ['#f59e0b', '#10b981', '#6d28d9'],
                    borderColor:     ['#d97706', '#059669', '#4c1d95'],
                    borderWidth: 2,
                    hoverOffset: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                var total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                                var pct   = total ? Math.round(ctx.raw/total*100) : 0;
                                return ' ' + ctx.label + ': ' + ctx.raw + ' (' + pct + '%)';
                            }
                        }
                    }
                }
            }
        });
    })();
</script>
}
